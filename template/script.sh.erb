#!/usr/bin/env bash

#
# Start RStudio Server
#

setup_env() {
  # Purge the module environment to avoid conflicts
  module purge

  # Load the require modules
  module load <%= context.modules %> <%= context.extra_modules %>

  # Activate conda env for R
  conda activate <%= context.conda_env %>

  # List loaded modules
  module list
}

setup_env

mkdir -p "$RSTUDIO_DATA_DIR"
mkdir -p "$RSTUDIO_CONFIG_DIR"
python3 -c 'from uuid import uuid4; print(uuid4())' > "$RSTUDIO_COOKIE_FILE"
chmod 0600 "$RSTUDIO_COOKIE_FILE"
if [ ! -e $DB_CONF_FILE ]
then
  cp "$RSTUDIO_ROOT/extras/conf/database.conf" "$DB_CONF_FILE"
  perl -pi -e "s@#directory=/var/lib/rstudio-server@directory=$RSTUDIO_DATA_DIR@" "$DB_CONF_FILE"
fi

set -x
# Launch the RStudio Server
echo "Starting up rserver..."

rserver --config-file "$RSERVER_CONF" 
